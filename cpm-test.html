<!DOCTYPE html>
<html>
<head>
    <title>Javascript Test Page</title>
    <script src="lib/sylvester.js" type="text/javascript"></script>
    <script src="cpm-sige.js" type="text/javascript"></script>
    <script src="dataframe.js" type="text/javascript"></script>
    <script src="d3.v3.min.js" charset="utf-8"></script>
    <link rel="stylesheet" href="cpm-app.css">
</head>
<body>
    <input type="file" id="files" name="file" multiple />
    <div id="file_select"></div>
    <div id="container"></div>
    <script>

    var filenameToolFields = function(file, i) {
        var nameRe = /(Q[A-Z0-9]+)_SERIE([0-9]+)/i;
        var name = file.name;
        var match = nameRe.exec(name);
        if (match) {
            return [name, match[1], match[2]];
        } else {
            return [name, "Tool " + String.fromCharCode(65 + i), "1"];
        }
    };

    var renderFileListTable = function(files) {
        var table = d3.select("#file_select").append("table")
        var thead = table.append("thead");
        var tbody = table.append("tbody");

        thead.append("tr")
            .selectAll("th")
            .data(["Filename", "Tool", "Reprod"])
            .enter()
            .append("th")
                .text(function(column) { return column; });

        // create a row for each object in the data
        var rows = tbody.selectAll("tr")
            .data(files, function(d) { return d.name; })
            .enter()
            .append("tr");

        // create a cell in each row for each column
        var cells = rows.selectAll("td")
            .data(filenameToolFields)
            .enter()
            .append("td")
                .html(function(d, i) {
                    if (i == 1) {
                        return "<input type=\"text\" value=" + JSON.stringify(d) + ">";
                    } else {
                        return d;
                    }
                });
    };

    var onLoadFile = function(evt) {
        if (evt.target.readyState == FileReader.DONE) {
            var parser = new FXParser(evt.target.result);
            var dt = parser.readDateTime();
            parser.readAll();
            for (var i in parser.tables) {
                renderMeasTable(parser.tables[i]);
                console.log(parser.tables[i]);
            }
        }
    };

    var handleFileSelect = function(evt) {
        var files = evt.target.files; // FileList object
        renderFileListTable(files);
        var button = d3.select("body").append("button").text("Go");
        button.on("click", function() {
            for (var i = 0, f; f = files[i]; i++) {
                var reader = new FileReader();
                reader.onloadend = onLoadFile;
                reader.readAsText(f);
            }
        });
    };

    document.getElementById('files').addEventListener('change', handleFileSelect, false);
    </script>
</body>
</html>
